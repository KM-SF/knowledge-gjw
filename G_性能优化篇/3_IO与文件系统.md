# 1.文件系统是怎么工作的

1. 文件系统，本身是对存储设备上的文件，进行组织和管理的机制。组织形式不同，就会生成不同的文件系统
2. 在Linux中一切皆文件，不仅扑通文件和目录、就连块设备、套接字、管道等，也都要通过统一的文件系统来管理
3. 为了方便管理，Linux 文件系统为[每个文件]都分配两个数据结构，索引节点index node和目录项directory entry，它们主要用来记录文件的元信息和目录结构
   1. 索引节点inode — 每个文件的唯一标志
      1. 功能：记录文件的元数据，比如 inode 编号、文件大小、访问权限、修改日期、数据的位置等。
      2. 索引节点和文件一一对应，它跟文件内容一样，都会被持久化存储到磁盘中。所以记住，索引节点同样占用磁盘空间。
   2. 目录项dentry — 维护的正是文件系统的树状结构
      1. 功能：记录文件的名字、索引节点的指针、与其他目录项关联关系。
      2. 多个关联的目录项，就构成了文件系统的目录结构。
   3. 目录项和索引节点的关系是多对一
      1. 你可以简单理解为，一个文件可以有多个别名。
      2. 举个例子，通过硬链接为文件创建的别名，就会对应不同的目录项，不过这些目录项本质上还是链接同一个文件，所以，它们的索引节点相同
4. 数据写到哪里呢？
   1. 问题：索引节点和目录项纪录了文件的元数据，以及文件间的目录关系，那么具体来说，文件数据到底是怎么存储的呢？是不是直接写到磁盘中就好了呢？
   2. 实际上，磁盘读写的最小单位是扇区，然而扇区只有 512B 大小，如果每次都读写这么小的单位，效率一定很低。所以，文件系统又把连续的扇区组成了逻辑块，然后每次都以逻辑块为最小单元，来管理数据。常见的逻辑块大小为 4KB，也就是由连续的 8 个扇区组成
   3. 磁盘在执行文件格式化时，会分成3个存储区域
      1. 超级块：存储整个文件系统的状态
      2. 索引节点区：用来存储索引节点(inode)
      3. 数据块区：用来存储文件数据(data)
5. 虚拟文件系统
   1. 目录项、索引节点、逻辑块以及超级块，构成了 Linux 文件系统的四大基本要素。不过，为了支持各种不同的文件系统，Linux 内核在用户进程和文件系统的中间，又引入了一个抽象层，也就是虚拟文件系统 VFS（Virtual File System）
   2. VFS 定义了一组所有文件系统都支持的数据结构和标准接口。这样，用户进程和内核中的其他子系统，只需要跟 VFS 提供的统一接口进行交互就可以了，而不需要再关心底层各种文件系统的实现细节。
   3. 文件系统分类
      1. 第一类是基于磁盘的文件系统，也就是把数据直接存储在计算机本地挂载的磁盘中。常见的 Ext4、XFS、OverlayFS 等，都是这类文件系统。
      2. 第二类是基于内存的文件系统，也就是我们常说的虚拟文件系统。这类文件系统，不需要任何磁盘分配存储空间，但会占用内存。我们经常用到的 /proc 文件系统，其实就是一种最常见的虚拟文件系统。此外，/sys 文件系统也属于这一类，主要向用户空间导出层次化的内核对象。
      3. 第三类是网络文件系统，也就是用来访问其他计算机数据的文件系统，比如 NFS、SMB、iSCSI 等。
   4. 这些文件系统，要先挂载到 VFS 目录树中的某个子目录（称为挂载点），然后才能访问其中的文件。==> 拿第一类，也就是基于磁盘的文件系统为例，在安装系统时，要先挂载一个根目录（/），在根目录下再把其他文件系统（比如其他的磁盘分区、/proc 文件系统、/sys 文件系统、NFS 等）挂载进来
6. 文件读写方式
   1. 缓冲与非缓冲I/O：根据是否利用标准库缓存，可以把文件 I/O 分为缓冲 I/O 与非缓冲 I/O。（它们最终还是要经过系统调用来访问文件。系统调用后，还会通过页缓存，来减少磁盘的 I/O 操作）
      1. 缓冲 I/O，是指利用标准库缓存来加速文件的访问，而标准库内部再通过系统调度访问文件
      2. 非缓冲 I/O，是指直接通过系统调用来访问文件，不再经过标准库缓存
   2. 直接 I/O 与非直接 I/O：根据是否利用操作系统的页缓存，可以把文件 I/O 分为直接 I/O 与非直接 I/O（通过指定O_DIRECT标记）
      1. 直接 I/O，是指跳过操作系统的页缓存，直接跟文件系统交互来访问文件。
      2. 非直接 I/O 正好相反，文件读写时，先要经过系统的页缓存，然后再由内核或额外的系统调用，真正写入磁盘。

# 2.性能指标

1. 性能模型
    - 读写比例
    - I/O 类型（随机还是连续）
    - I/O 的大小
2. 举例
   1. 在数据库、大量小文件等这类随机读写比较多的场景中，IOPS 更能反映系统的整体性能
   2. 在多媒体等顺序读写较多的场景中，吞吐量才更能反映系统的整体性能。
3. 磁盘性能指标
   1. 使用率，是指磁盘处理 I/O 的时间百分比。
      - 过高的使用率（比如超过 80%），通常意味着磁盘 I/O 存在性能瓶颈。
   2. 饱和度，是指磁盘处理 I/O 的繁忙程度。
      - 过高的饱和度，意味着磁盘存在严重的性能瓶颈。当饱和度为 100% 时，磁盘无法接受新的 I/O 请求。
   3. IOPS（Input/Output Per Second），是指每秒的 I/O 请求数。
   4. 吞吐量，是指每秒的 I/O 请求大小。
   5. 响应时间，是指 I/O 请求从发出到收到响应的间隔时间。

